"use client";

import { useMemo, useState } from "react";
import ServiceMicroQuestions from "@/components/ServiceMicroQuestions";
import LiveNowBadge from "@/components/LiveNowBadge";

type Step = "service" | "postcode" | "timing" | "estimate";

export default function QuotePage() {
  const [step, setStep] = useState<Step>("service");

  // Core fields (existing)
  const [service, setService] = useState<string | null>(null);
  const [postcode, setPostcode] = useState("");
  const [urgency, setUrgency] = useState<string | null>(null);

  // New
  const [details, setDetails] = useState<Record<string, string>>({});
  const [description, setDescription] = useState("");
  const [photos, setPhotos] = useState<string[]>([]); // store data URLs (MVP)

  const canContinueService = useMemo(() => !!service, [service]);
  const canContinuePostcode = useMemo(() => postcode.trim().length >= 2, [postcode]);
  const canContinueTiming = useMemo(() => !!urgency, [urgency]);

  function nextFromService() {
    if (!canContinueService) return;
    setStep("postcode");
  }

  async function submitLead() {
    const payload = { service, postcode: postcode.trim(), urgency, details, description, photos };
    try {
      const [aiRes, leadRes] = await Promise.all([
        fetch("/api/aiQuote", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        }),
        fetch("/api/lead", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
        }),
      ]);

      if (!aiRes.ok) throw new Error("AI quote failed");
      if (!leadRes.ok) throw new Error("Lead save failed");

      window.location.href = "/quote/success";
    } catch (e) {
      console.error(e);
      alert("Something went wrong. Please try again.");
    }
  }

  const optionBtn = (active: boolean) =>
    `h-10 rounded-md border text-sm px-3 text-left transition ${
      active ? "border-emerald-500 bg-emerald-50 text-emerald-700" : "border-gray-200 hover:border-gray-300"
    }`;

  // File -> dataURL helper (MVP; switch to S3 in prod)
  async function handleFiles(files: FileList | null) {
    if (!files || !files.length) return;
    const readAll = Array.from(files).slice(0, 8).map(
      (f) =>
        new Promise<string>((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result as string);
          r.onerror = reject;
          r.readAsDataURL(f);
        })
    );
    const urls = await Promise.all(readAll);
    setPhotos((prev) => [...prev, ...urls].slice(0, 8));
  }

  return (
    <div className="mx-auto max-w-5xl px-4 py-8">
      {/* Header row with badge (matches original look) */}
      <div className="flex items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl md:text-4xl font-extrabold tracking-tight">
            Your instant, AI-powered quote — <span className="text-emerald-600">fair, fast, and</span>{" "}
            <span className="text-emerald-600">guaranteed.</span>
          </h1>
          <p className="mt-2 text-gray-600">
            No pushy sales calls. No guesswork. Just trusted local builders with 10+ years experience.
          </p>
        </div>
        <div className="hidden md:block">
          <LiveNowBadge />
        </div>
      </div>

      {/* Two-column layout container (unchanged structure) */}
      <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* Left: main card */}
        <div className="md:col-span-2 rounded-2xl border border-gray-200 p-4 md:p-6">
          {/* Progress bar */}
          <div className="h-1 bg-gray-100 rounded">
            <div
              className="h-1 bg-emerald-500 rounded transition-all"
              style={{ width: step === "service" ? "33%" : step === "postcode" ? "66%" : "100%" }}
            />
          </div>

          {/* Steps */}
          {step === "service" && (
            <div className="mt-6">
              <div className="text-sm text-gray-600 mb-2">Select service type</div>

              <div className="grid grid-cols-2 gap-2">
                {[
                  "Kitchen renovation",
                  "Bathroom refurbishment",
                  "Loft conversion",
                  "House extension",
                  "Roofing",
                  "Plastering",
                  "Electrical",
                  "Plumbing",
                ].map((label) => {
                  const val = label.toLowerCase();
                  const active = service === val;
                  return (
                    <button
                      key={val}
                      type="button"
                      onClick={() => setService(val)}
                      className={optionBtn(active)}
                    >
                      {label}
                    </button>
                  );
                })}
              </div>

              {/* Micro-questions */}
              <ServiceMicroQuestions
                service={service}
                values={details}
                onChange={(id, value) => setDetails((d) => ({ ...d, [id]: value }))}
              />

              {/* Description (compact textarea, same card; minimal visual) */}
              <div className="mt-4 space-y-2">
                <div className="text-sm font-medium text-gray-700">Brief description (optional)</div>
                <textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  rows={3}
                  placeholder="Tell us anything important (sizes, finishes, access)…"
                  className="w-full rounded-md border border-gray-200 px-3 py-2 text-sm"
                />
              </div>

              {/* Photos (simple input; previews count only to avoid layout shifts) */}
              <div className="mt-4 space-y-2">
                <div className="text-sm font-medium text-gray-700">Add photos (optional)</div>
                <input
                  type="file"
                  accept="image/*"
                  multiple
                  onChange={(e) => handleFiles(e.target.files)}
                  className="block w-full text-sm text-gray-700"
                />
                {photos.length > 0 && (
                  <div className="text-xs text-gray-600">Selected: {photos.length} photo(s)</div>
                )}
              </div>

              <div className="mt-6 flex justify-end">
                <button
                  type="button"
                  onClick={nextFromService}
                  disabled={!canContinueService}
                  className="h-10 px-4 rounded-md bg-emerald-600 text-white disabled:opacity-40"
                >
                  Next
                </button>
              </div>
            </div>
          )}

          {step === "postcode" && (
            <div className="mt-6">
              <div className="text-sm text-gray-600 mb-2">Enter your postcode</div>
              <input
                value={postcode}
                onChange={(e) => setPostcode(e.target.value.toUpperCase())}
                placeholder="e.g. ME1"
                className="w-full h-10 rounded-md border border-gray-200 px-3"
              />
              <div className="mt-4 flex items-center gap-2">
                <button type="button" onClick={() => setStep("service")} className="text-gray-600 underline">
                  Back
                </button>
                <div className="flex-1" />
                <button
                  type="button"
                  onClick={() => setStep("timing")}
                  disabled={!canContinuePostcode}
                  className="h-10 px-4 rounded-md bg-emerald-600 text-white disabled:opacity-40"
                >
                  Next
                </button>
              </div>
            </div>
          )}

          {step === "timing" && (
            <div className="mt-6">
              <div className="text-sm text-gray-600 mb-2">Choose timing</div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                {[
                  { v: "ASAP", l: "ASAP" },
                  { v: "1-3 months", l: "1–3 months" },
                  { v: "3-6 months", l: "3–6 months" },
                  { v: "planning", l: "Just planning" },
                ].map((o) => (
                  <button
                    key={o.v}
                    type="button"
                    onClick={() => setUrgency(o.v)}
                    className={optionBtn(urgency === o.v)}
                  >
                    {o.l}
                  </button>
                ))}
              </div>
              <div className="mt-4 flex items-center gap-2">
                <button type="button" onClick={() => setStep("postcode")} className="text-gray-600 underline">
                  Back
                </button>
                <div className="flex-1" />
                <button
                  type="button"
                  onClick={() => setStep("estimate")}
                  disabled={!canContinueTiming}
                  className="h-10 px-4 rounded-md bg-emerald-600 text-white disabled:opacity-40"
                >
                  See instant estimate
                </button>
              </div>
            </div>
          )}

          {step === "estimate" && (
            <div className="mt-6">
              <div className="text-sm text-gray-600 mb-2">Review & submit</div>
              <div className="rounded-md border border-gray-200 p-3 text-sm text-gray-700">
                <div><strong>Service:</strong> {service}</div>
                <div><strong>Postcode:</strong> {postcode}</div>
                <div><strong>Timing:</strong> {urgency}</div>
                {Object.keys(details).length > 0 && (
                  <div className="mt-2">
                    <strong>Details:</strong>
                    <ul className="list-disc ml-5">
                      {Object.entries(details).map(([k, v]) => (
                        <li key={k}>{k}: {v}</li>
                      ))}
                    </ul>
                  </div>
                )}
                {description && (
                  <div className="mt-2">
                    <strong>Description:</strong>
                    <div className="whitespace-pre-wrap">{description}</div>
                  </div>
                )}
                {photos.length > 0 && (
                  <div className="mt-2">
                    <strong>Photos:</strong> {photos.length} attached
                  </div>
                )}
              </div>
              <div className="mt-4 flex items-center gap-2">
                <button type="button" onClick={() => setStep("timing")} className="text-gray-600 underline">
                  Back
                </button>
                <div className="flex-1" />
                <button
                  type="button"
                  onClick={submitLead}
                  className="h-10 px-4 rounded-md bg-emerald-600 text-white"
                >
                  Submit & get estimate
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Right: trust sidebar (unchanged placeholder) */}
        <div className="rounded-2xl border border-gray-200 p-4 md:p-6">
          <div className="text-sm text-gray-700">Why homeowners choose us</div>
          <ul className="mt-2 space-y-1 text-sm text-gray-600">
            <li>✓ 2,300+ successful projects</li>
            <li>✓ 4.9/5 rating</li>
            <li>✓ £5m Public Liability cover</li>
            <li>✓ 12-month workmanship guarantee</li>
            <li>✓ Verified & DBS-checked teams</li>
          </ul>
        </div>
      </div>
    </div>
  );
}
