import { getServerSession } from "next-auth";
import type { Session } from "next-auth";
import { authOptions } from "@/lib/auth/options";

/** Server-side role guard (server components / route handlers) */
export async function requireRole(
  roles: Array<"ADMIN" | "TRADER" | "HOMEOWNER">
) {
  const session = (await getServerSession(authOptions)) as Session | null;
  if (!session?.user) throw new Error("UNAUTHENTICATED");
  const role = (session.user as any)?.role ?? "HOMEOWNER";
  if (!roles.includes(role)) throw new Error("FORBIDDEN");
  return session.user;
}
